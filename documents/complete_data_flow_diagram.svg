<svg viewBox="0 0 1800 2400" xmlns="http://www.w3.org/2000/svg">
  <!-- Title -->
  <text x="900" y="30" font-size="28" font-weight="bold" text-anchor="middle" fill="#1a1a1a">
    ChronoTrace - Complete Data Flow Diagram
  </text>
  <text x="900" y="55" font-size="14" text-anchor="middle" fill="#666">
    All Components, Data Flows, and Database Interactions
  </text>
  
  <!-- Legend -->
  <rect x="50" y="80" width="1700" height="100" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2" rx="8"/>
  <text x="900" y="105" font-size="16" font-weight="bold" text-anchor="middle">LEGEND</text>
  
  <line x1="100" y1="130" x2="200" y2="130" stroke="#2196F3" stroke-width="3" marker-end="url(#arrow-blue)"/>
  <text x="210" y="135" font-size="12">User Request / Query Data</text>
  
  <line x1="400" y1="130" x2="500" y2="130" stroke="#4CAF50" stroke-width="3" marker-end="url(#arrow-green)"/>
  <text x="510" y="135" font-size="12">Processing / System Flow</text>
  
  <line x1="700" y1="130" x2="800" y2="130" stroke="#FF9800" stroke-width="3" stroke-dasharray="5,5" marker-end="url(#arrow-orange)"/>
  <text x="810" y="135" font-size="12">External API Call (AWS)</text>
  
  <line x1="1050" y1="130" x2="1150" y2="130" stroke="#9C27B0" stroke-width="3" marker-end="url(#arrow-purple)"/>
  <text x="1160" y="135" font-size="12">Database Read/Write</text>
  
  <line x1="1400" y1="130" x2="1500" y2="130" stroke="#F44336" stroke-width="2" stroke-dasharray="2,2" marker-end="url(#arrow-red)"/>
  <text x="1510" y="135" font-size="12">Real-time WebSocket</text>
  
  <!-- USER INTERACTION LAYER -->
  <rect x="50" y="220" width="1700" height="180" fill="#E3F2FD" stroke="#2196F3" stroke-width="3" rx="10"/>
  <text x="900" y="250" font-size="18" font-weight="bold" text-anchor="middle">1. USER INTERACTION LAYER</text>
  
  <!-- Web Client -->
  <rect x="100" y="270" width="280" height="100" fill="#fff" stroke="#2196F3" stroke-width="2" rx="5"/>
  <text x="240" y="295" font-size="14" font-weight="bold" text-anchor="middle">üåê Web Client (React)</text>
  <text x="240" y="315" font-size="10" text-anchor="middle">Sends:</text>
  <text x="240" y="330" font-size="9" text-anchor="middle">‚Ä¢ Video files (multipart/form-data)</text>
  <text x="240" y="343" font-size="9" text-anchor="middle">‚Ä¢ Search queries (JSON)</text>
  <text x="240" y="356" font-size="9" text-anchor="middle">‚Ä¢ Filter parameters (JSON)</text>
  
  <!-- Mobile Client -->
  <rect x="420" y="270" width="280" height="100" fill="#fff" stroke="#2196F3" stroke-width="2" rx="5"/>
  <text x="560" y="295" font-size="14" font-weight="bold" text-anchor="middle">üì± Mobile Client</text>
  <text x="560" y="315" font-size="10" text-anchor="middle">Sends:</text>
  <text x="560" y="330" font-size="9" text-anchor="middle">‚Ä¢ Live stream URLs</text>
  <text x="560" y="343" font-size="9" text-anchor="middle">‚Ä¢ Voice queries (audio data)</text>
  <text x="560" y="356" font-size="9" text-anchor="middle">‚Ä¢ Real-time search requests</text>
  
  <!-- API Consumers -->
  <rect x="740" y="270" width="280" height="100" fill="#fff" stroke="#2196F3" stroke-width="2" rx="5"/>
  <text x="880" y="295" font-size="14" font-weight="bold" text-anchor="middle">üîå API Consumers</text>
  <text x="880" y="315" font-size="10" text-anchor="middle">Sends:</text>
  <text x="880" y="330" font-size="9" text-anchor="middle">‚Ä¢ Webhook subscriptions</text>
  <text x="880" y="343" font-size="9" text-anchor="middle">‚Ä¢ Batch processing requests</text>
  <text x="880" y="356" font-size="9" text-anchor="middle">‚Ä¢ API key authentication</text>
  
  <!-- Admin Dashboard -->
  <rect x="1060" y="270" width="280" height="100" fill="#fff" stroke="#2196F3" stroke-width="2" rx="5"/>
  <text x="1200" y="295" font-size="14" font-weight="bold" text-anchor="middle">‚öôÔ∏è Admin Dashboard</text>
  <text x="1200" y="315" font-size="10" text-anchor="middle">Sends:</text>
  <text x="1200" y="330" font-size="9" text-anchor="middle">‚Ä¢ User management commands</text>
  <text x="1200" y="343" font-size="9" text-anchor="middle">‚Ä¢ System configuration</text>
  <text x="1200" y="356" font-size="9" text-anchor="middle">‚Ä¢ Analytics queries</text>
  
  <!-- WebSocket Connection -->
  <rect x="1380" y="270" width="340" height="100" fill="#FFEBEE" stroke="#F44336" stroke-width="2" rx="5" stroke-dasharray="5,5"/>
  <text x="1550" y="295" font-size="14" font-weight="bold" text-anchor="middle">üîÑ WebSocket Connection</text>
  <text x="1550" y="315" font-size="10" text-anchor="middle">Real-time Updates:</text>
  <text x="1550" y="330" font-size="9" text-anchor="middle">‚Ä¢ Live search results</text>
  <text x="1550" y="343" font-size="9" text-anchor="middle">‚Ä¢ Processing status</text>
  <text x="1550" y="356" font-size="9" text-anchor="middle">‚Ä¢ Anomaly alerts</text>
  
  <!-- API GATEWAY -->
  <rect x="50" y="450" width="1700" height="120" fill="#F3E5F5" stroke="#9C27B0" stroke-width="3" rx="10"/>
  <text x="900" y="480" font-size="18" font-weight="bold" text-anchor="middle">2. API GATEWAY / LOAD BALANCER</text>
  
  <rect x="300" y="500" width="1200" height="50" fill="#fff" stroke="#9C27B0" stroke-width="2" rx="5"/>
  <text x="900" y="525" font-size="12" font-weight="bold" text-anchor="middle">nginx Reverse Proxy + SSL Termination</text>
  <text x="900" y="543" font-size="10" text-anchor="middle">
    Routes: /api/* ‚Üí FastAPI | /ws/* ‚Üí WebSocket | /static/* ‚Üí CDN | Authentication & Rate Limiting
  </text>
  
  <!-- Arrows from User Layer to API Gateway -->
  <path d="M 240 370 L 240 450" stroke="#2196F3" stroke-width="3" marker-end="url(#arrow-blue)"/>
  <text x="250" y="410" font-size="10" fill="#2196F3">HTTP/HTTPS</text>
  
  <path d="M 560 370 L 560 450" stroke="#2196F3" stroke-width="3" marker-end="url(#arrow-blue)"/>
  <path d="M 880 370 L 880 450" stroke="#2196F3" stroke-width="3" marker-end="url(#arrow-blue)"/>
  <path d="M 1200 370 L 1200 450" stroke="#2196F3" stroke-width="3" marker-end="url(#arrow-blue)"/>
  <path d="M 1550 370 L 1550 450" stroke="#F44336" stroke-width="2" stroke-dasharray="2,2" marker-end="url(#arrow-red)"/>
  
  <!-- APPLICATION LAYER -->
  <rect x="50" y="620" width="850" height="380" fill="#E8F5E9" stroke="#4CAF50" stroke-width="3" rx="10"/>
  <text x="475" y="650" font-size="18" font-weight="bold" text-anchor="middle">3. APPLICATION LAYER</text>
  
  <!-- FastAPI Server -->
  <rect x="100" y="670" width="380" height="300" fill="#fff" stroke="#4CAF50" stroke-width="2" rx="5"/>
  <text x="290" y="695" font-size="14" font-weight="bold" text-anchor="middle">‚ö° FastAPI Server</text>
  
  <!-- Endpoints -->
  <rect x="120" y="710" width="340" height="240" fill="#f8f9fa" stroke="#4CAF50" stroke-width="1" rx="3"/>
  <text x="290" y="730" font-size="11" font-weight="bold" text-anchor="middle">API Endpoints & Data Flow:</text>
  
  <text x="130" y="750" font-size="9" font-weight="bold">POST /api/videos/upload</text>
  <text x="135" y="763" font-size="8">‚Üí Receives: multipart file (video)</text>
  <text x="135" y="775" font-size="8">‚Üí Returns: {video_id, status}</text>
  <text x="135" y="787" font-size="8">‚Üí Triggers: Celery task (process_video)</text>
  
  <text x="130" y="805" font-size="9" font-weight="bold">POST /api/search</text>
  <text x="135" y="818" font-size="8">‚Üí Receives: {query, filters, limit}</text>
  <text x="135" y="830" font-size="8">‚Üí Calls: Nova (text embedding)</text>
  <text x="135" y="842" font-size="8">‚Üí Queries: Qdrant (vector search)</text>
  <text x="135" y="854" font-size="8">‚Üí Joins: PostgreSQL (metadata)</text>
  <text x="135" y="866" font-size="8">‚Üí Returns: [{segment_id, score, metadata}]</text>
  
  <text x="130" y="884" font-size="9" font-weight="bold">GET /api/videos/{id}/segments</text>
  <text x="135" y="897" font-size="8">‚Üí Queries: PostgreSQL (segments table)</text>
  <text x="135" y="909" font-size="8">‚Üí Returns: segment list with thumbnails</text>
  
  <text x="130" y="927" font-size="9" font-weight="bold">POST /api/reports/generate</text>
  <text x="135" y="940" font-size="8">‚Üí Triggers: LangGraph agent</text>
  
  <!-- Celery Workers -->
  <rect x="510" y="670" width="360" height="300" fill="#fff" stroke="#4CAF50" stroke-width="2" rx="5"/>
  <text x="690" y="695" font-size="14" font-weight="bold" text-anchor="middle">‚öôÔ∏è Celery Workers</text>
  
  <rect x="530" y="710" width="320" height="240" fill="#f8f9fa" stroke="#4CAF50" stroke-width="1" rx="3"/>
  <text x="690" y="730" font-size="11" font-weight="bold" text-anchor="middle">Background Tasks:</text>
  
  <text x="540" y="750" font-size="9" font-weight="bold">Task: process_video(video_id)</text>
  <text x="545" y="763" font-size="8">1. Read video from S3/local storage</text>
  <text x="545" y="775" font-size="8">2. Extract metadata (FFmpeg probe)</text>
  <text x="545" y="787" font-size="8">3. Segment video (15s chunks)</text>
  <text x="545" y="799" font-size="8">4. Generate thumbnails (OpenCV)</text>
  <text x="545" y="811" font-size="8">5. Extract audio tracks</text>
  <text x="545" y="823" font-size="8">6. Apply privacy blur (MediaPipe)</text>
  <text x="545" y="835" font-size="8">7. Update PostgreSQL (segments table)</text>
  <text x="545" y="847" font-size="8">8. Trigger: generate_embeddings()</text>
  
  <text x="540" y="867" font-size="9" font-weight="bold">Task: generate_embeddings(segment_id)</text>
  <text x="545" y="880" font-size="8">1. Check embedding cache (Redis)</text>
  <text x="545" y="892" font-size="8">2. If not cached: Call Nova API</text>
  <text x="545" y="904" font-size="8">3. Store vector in Qdrant (1024-dim)</text>
  <text x="545" y="916" font-size="8">4. Cache embedding in Redis</text>
  <text x="545" y="928" font-size="8">5. Update segment.embedding_id</text>
  
  <!-- Arrows from API Gateway to App Layer -->
  <path d="M 400 570 L 290 620" stroke="#4CAF50" stroke-width="3" marker-end="url(#arrow-green)"/>
  <text x="330" y="595" font-size="10" fill="#4CAF50">HTTP Requests</text>
  
  <path d="M 600 570 L 690 620" stroke="#4CAF50" stroke-width="3" marker-end="url(#arrow-green)"/>
  <text x="630" y="595" font-size="10" fill="#4CAF50">Task Queue</text>
  
  <!-- AI/ML LAYER -->
  <rect x="950" y="620" width="800" height="380" fill="#FFF3E0" stroke="#FF9800" stroke-width="3" rx="10"/>
  <text x="1350" y="650" font-size="18" font-weight="bold" text-anchor="middle">4. AI/ML PROCESSING LAYER</text>
  
  <!-- LangGraph -->
  <rect x="980" y="670" width="360" height="140" fill="#fff" stroke="#FF9800" stroke-width="2" rx="5"/>
  <text x="1160" y="695" font-size="14" font-weight="bold" text-anchor="middle">üîó LangGraph Agent</text>
  
  <text x="990" y="715" font-size="9" font-weight="bold">Multi-Step Query Processing:</text>
  <text x="995" y="730" font-size="8">Input: Complex query + context</text>
  <text x="995" y="742" font-size="8">1. Query understanding (Nova Lite)</text>
  <text x="995" y="754" font-size="8">2. Break into sub-queries</text>
  <text x="995" y="766" font-size="8">3. Execute searches in sequence</text>
  <text x="995" y="778" font-size="8">4. Synthesize results</text>
  <text x="995" y="790" font-size="8">Output: Structured answer + timeline</text>
  
  <!-- Nova Models -->
  <rect x="980" y="830" width="360" height="150" fill="#FFE0B2" stroke="#FF9800" stroke-width="2" rx="5"/>
  <text x="1160" y="855" font-size="14" font-weight="bold" text-anchor="middle">üß† AWS Nova Models</text>
  
  <text x="990" y="875" font-size="9" font-weight="bold">API Calls & Data:</text>
  
  <text x="995" y="893" font-size="8" font-weight="bold">Nova Multimodal Embeddings:</text>
  <text x="1000" y="905" font-size="8">Input: Video bytes (base64) + Audio bytes</text>
  <text x="1000" y="917" font-size="8">Output: 1024-dim float vector</text>
  <text x="1000" y="929" font-size="8">Cost: ~$0.001 per segment</text>
  
  <text x="995" y="947" font-size="8" font-weight="bold">Nova 2 Lite (LLM):</text>
  <text x="1000" y="959" font-size="8">Input: Prompt + search results</text>
  <text x="1000" y="971" font-size="8">Output: Generated text (report/timeline)</text>
  
  <!-- Computer Vision -->
  <rect x="1370" y="670" width="350" height="310" fill="#fff" stroke="#FF9800" stroke-width="2" rx="5"/>
  <text x="1545" y="695" font-size="14" font-weight="bold" text-anchor="middle">üëÅÔ∏è Computer Vision Pipeline</text>
  
  <text x="1380" y="715" font-size="9" font-weight="bold">MediaPipe Face Detection:</text>
  <text x="1385" y="728" font-size="8">Input: Video frame (numpy array)</text>
  <text x="1385" y="740" font-size="8">Process: Detect face bounding boxes</text>
  <text x="1385" y="752" font-size="8">Output: [(x, y, w, h)] coordinates</text>
  <text x="1385" y="764" font-size="8">Action: Apply Gaussian blur</text>
  
  <text x="1380" y="782" font-size="9" font-weight="bold">FFmpeg Processing:</text>
  <text x="1385" y="795" font-size="8">Input: Raw video file path</text>
  <text x="1385" y="807" font-size="8">Operations:</text>
  <text x="1390" y="819" font-size="7">‚Ä¢ Probe metadata (duration, fps, codec)</text>
  <text x="1390" y="831" font-size="7">‚Ä¢ Segment (15s chunks, copy codec)</text>
  <text x="1390" y="843" font-size="7">‚Ä¢ Extract audio (AAC format)</text>
  <text x="1390" y="855" font-size="7">‚Ä¢ Generate thumbnails (JPEG)</text>
  <text x="1385" y="867" font-size="8">Output: Segment files + metadata JSON</text>
  
  <text x="1380" y="885" font-size="9" font-weight="bold">OpenCV Operations:</text>
  <text x="1385" y="898" font-size="8">‚Ä¢ Frame extraction</text>
  <text x="1385" y="910" font-size="8">‚Ä¢ Image resizing (thumbnails)</text>
  <text x="1385" y="922" font-size="8">‚Ä¢ Color space conversion</text>
  <text x="1385" y="934" font-size="8">‚Ä¢ Blur application</text>
  
  <text x="1380" y="952" font-size="9" font-weight="bold">Anomaly Detection:</text>
  <text x="1385" y="965" font-size="8">Analyze: Motion patterns, dwell time</text>
  <text x="1385" y="977" font-size="8">Detect: Loitering, crowds, abandonment</text>
  
  <!-- Arrows between App and AI layers -->
  <path d="M 480 820 L 980 750" stroke="#FF9800" stroke-width="3" stroke-dasharray="5,5" marker-end="url(#arrow-orange)"/>
  <text x="650" y="770" font-size="10" fill="#FF9800">Nova API Calls</text>
  
  <path d="M 870 820 L 1370 750" stroke="#4CAF50" stroke-width="2" marker-end="url(#arrow-green)"/>
  <text x="1050" y="770" font-size="10" fill="#4CAF50">CV Processing</text>
  
  <!-- DATA LAYER -->
  <rect x="50" y="1050" width="1700" height="550" fill="#E1F5FE" stroke="#03A9F4" stroke-width="3" rx="10"/>
  <text x="900" y="1080" font-size="18" font-weight="bold" text-anchor="middle">5. DATA PERSISTENCE LAYER</text>
  
  <!-- PostgreSQL -->
  <rect x="100" y="1100" width="380" height="460" fill="#fff" stroke="#0288D1" stroke-width="2" rx="5"/>
  <text x="290" y="1125" font-size="14" font-weight="bold" text-anchor="middle">üêò PostgreSQL Database</text>
  
  <text x="110" y="1145" font-size="10" font-weight="bold">Schema & Data Flow:</text>
  
  <!-- Tables breakdown -->
  <rect x="120" y="1155" width="340" height="385" fill="#f8f9fa" stroke="#0288D1" stroke-width="1" rx="3"/>
  
  <text x="130" y="1173" font-size="9" font-weight="bold">videos table:</text>
  <text x="135" y="1185" font-size="7">Write: POST /upload ‚Üí INSERT video record</text>
  <text x="135" y="1196" font-size="7">Update: Celery ‚Üí UPDATE processing_status</text>
  <text x="135" y="1207" font-size="7">Read: GET /videos ‚Üí SELECT with filters</text>
  <text x="135" y="1218" font-size="7">Stores: id, filename, s3_key, duration, fps, metadata</text>
  
  <text x="130" y="1236" font-size="9" font-weight="bold">video_segments table:</text>
  <text x="135" y="1248" font-size="7">Write: Celery ‚Üí INSERT segments after processing</text>
  <text x="135" y="1259" font-size="7">Update: Celery ‚Üí UPDATE embedding_id after Nova</text>
  <text x="135" y="1270" font-size="7">Read: Search ‚Üí JOIN with results</text>
  <text x="135" y="1281" font-size="7">Stores: segment_index, start_time, end_time,</text>
  <text x="135" y="1291" font-size="7">        thumbnail_path, embedding_id, camera_id</text>
  
  <text x="130" y="1309" font-size="9" font-weight="bold">users table:</text>
  <text x="135" y="1321" font-size="7">Write: POST /register ‚Üí INSERT new user</text>
  <text x="135" y="1332" font-size="7">Read: POST /login ‚Üí SELECT for auth</text>
  <text x="135" y="1343" font-size="7">Stores: id, email, password_hash, role</text>
  
  <text x="130" y="1361" font-size="9" font-weight="bold">searches table (Analytics):</text>
  <text x="135" y="1373" font-size="7">Write: Every search ‚Üí INSERT search log</text>
  <text x="135" y="1384" font-size="7">Read: Admin dashboard ‚Üí Aggregate queries</text>
  <text x="135" y="1395" font-size="7">Stores: query_text, filters, result_count, time_ms</text>
  
  <text x="130" y="1413" font-size="9" font-weight="bold">anomalies table:</text>
  <text x="135" y="1425" font-size="7">Write: Detection ‚Üí INSERT anomaly record</text>
  <text x="135" y="1436" font-size="7">Read: Dashboard ‚Üí SELECT unresolved</text>
  <text x="135" y="1447" font-size="7">Stores: segment_id, type, confidence, description</text>
  
  <text x="130" y="1465" font-size="9" font-weight="bold">audit_log table:</text>
  <text x="135" y="1477" font-size="7">Write: PII access ‚Üí INSERT audit entry</text>
  <text x="135" y="1488" font-size="7">Read: Compliance ‚Üí SELECT by user/resource</text>
  <text x="135" y="1499" font-size="7">Stores: user_id, action, resource_id, timestamp</text>
  
  <text x="130" y="1517" font-size="9" font-weight="bold">api_keys table:</text>
  <text x="135" y="1529" font-size="7">Write: Generate API key ‚Üí INSERT</text>
  <text x="135" y="1540" font-size="7">Update: API call ‚Üí UPDATE last_used_at</text>
  
  <!-- Qdrant -->
  <rect x="510" y="1100" width="400" height="460" fill="#fff" stroke="#0288D1" stroke-width="2" rx="5"/>
  <text x="710" y="1125" font-size="14" font-weight="bold" text-anchor="middle">üîç Qdrant Vector Database</text>
  
  <text x="520" y="1145" font-size="10" font-weight="bold">Collection: video_segments</text>
  
  <rect x="530" y="1155" width="360" height="385" fill="#f8f9fa" stroke="#0288D1" stroke-width="1" rx="3"/>
  
  <text x="540" y="1173" font-size="9" font-weight="bold">Vector Structure:</text>
  <text x="545" y="1187" font-size="8">dimension: 1024 (float32 array)</text>
  <text x="545" y="1200" font-size="8">distance_metric: Cosine Similarity</text>
  <text x="545" y="1213" font-size="8">index_type: HNSW (fast approximate search)</text>
  
  <text x="540" y="1233" font-size="9" font-weight="bold">Data Flow:</text>
  
  <text x="545" y="1250" font-size="8" font-weight="bold">Write (Upsert):</text>
  <text x="550" y="1263" font-size="7">Trigger: After Nova embedding generation</text>
  <text x="550" y="1275" font-size="7">Data Structure:</text>
  <text x="555" y="1286" font-size="7">{</text>
  <text x="560" y="1297" font-size="7">id: "uuid-string",</text>
  <text x="560" y="1308" font-size="7">vector: [float √ó 1024],</text>
  <text x="560" y="1319" font-size="7">payload: {</text>
  <text x="565" y="1330" font-size="7">segment_id: "uuid",</text>
  <text x="565" y="1341" font-size="7">video_id: "uuid",</text>
  <text x="565" y="1352" font-size="7">start_time: float,</text>
  <text x="565" y="1363" font-size="7">end_time: float,</text>
  <text x="565" y="1374" font-size="7">camera_id: "string",</text>
  <text x="565" y="1385" font-size="7">location: "string",</text>
  <text x="565" y="1396" font-size="7">has_faces: boolean,</text>
  <text x="565" y="1407" font-size="7">privacy_applied: boolean,</text>
  <text x="565" y="1418" font-size="7">timestamp: datetime</text>
  <text x="560" y="1429" font-size="7">}</text>
  <text x="555" y="1440" font-size="7">}</text>
  
  <text x="545" y="1458" font-size="8" font-weight="bold">Read (Search):</text>
  <text x="550" y="1471" font-size="7">Trigger: POST /api/search request</text>
  <text x="550" y="1483" font-size="7">Query: query_vector (1024-dim from Nova)</text>
  <text x="550" y="1495" font-size="7">Filters: camera_id, time_range, location</text>
  <text x="550" y="1507" font-size="7">Limit: top_k results (default 10)</text>
  <text x="550" y="1519" font-size="7">Returns: [{id, score, payload}, ...]</text>
  <text x="550" y="1531" font-size="7">Performance: ~50ms for 1M vectors</text>
  
  <!-- Redis -->
  <rect x="940" y="1100" width="350" height="220" fill="#fff" stroke="#0288D1" stroke-width="2" rx="5"/>
  <text x="1115" y="1125" font-size="14" font-weight="bold" text-anchor="middle">‚ö° Redis Cache</text>
  
  <rect x="960" y="1140" width="310" height="165" fill="#f8f9fa" stroke="#0288D1" stroke-width="1" rx="3"/>
  
  <text x="970" y="1158" font-size="9" font-weight="bold">Cache Keys & Data:</text>
  
  <text x="975" y="1175" font-size="8" font-weight="bold">embedding_cache:{video_hash}</text>
  <text x="980" y="1187" font-size="7">Value: JSON {embedding: [1024 floats]}</text>
  <text x="980" y="1198" font-size="7">TTL: 7 days</text>
  <text x="980" y="1209" font-size="7">Purpose: Avoid re-calling Nova API</text>
  
  <text x="975" y="1226" font-size="8" font-weight="bold">search_results:{query_hash}</text>
  <text x="980" y="1238" font-size="7">Value: JSON [{segment_id, score}, ...]</text>
  <text x="980" y="1249" font-size="7">TTL: 1 hour</text>
  <text x="980" y="1260" font-size="7">Purpose: Fast repeat queries</text>
  
  <text x="975" y="1277" font-size="8" font-weight="bold">session:{session_id}</text>
  <text x="980" y="1289" font-size="7">Value: JSON {user_id, auth_token}</text>
  <text x="980" y="1300" font-size="7">TTL: 30 minutes</text>
  
  <!-- S3 -->
  <rect x="940" y="1340" width="350" height="220" fill="#fff" stroke="#0288D1" stroke-width="2" rx="5"/>
  <text x="1115" y="1365" font-size="14" font-weight="bold" text-anchor="middle">üì¶ AWS S3 Storage</text>
  
  <rect x="960" y="1380" width="310" height="165" fill="#f8f9fa" stroke="#0288D1" stroke-width="1" rx="3"/>
  
  <text x="970" y="1398" font-size="9" font-weight="bold">Bucket Structure:</text>
  
  <text x="975" y="1415" font-size="8">/raw-videos/</text>
  <text x="980" y="1427" font-size="7">Original uploaded files</text>
  <text x="980" y="1438" font-size="7">Lifecycle: 90 days ‚Üí Glacier</text>
  
  <text x="975" y="1455" font-size="8">/processed/segments/</text>
  <text x="980" y="1467" font-size="7">15-second video chunks</text>
  <text x="980" y="1478" font-size="7">Lifecycle: 30 days ‚Üí Delete</text>
  
  <text x="975" y="1495" font-size="8">/thumbnails/</text>
  <text x="980" y="1507" font-size="7">JPEG thumbnails (320px wide)</text>
  
  <text x="975" y="1524" font-size="8">/exports/</text>
  <text x="980" y="1536" font-size="7">User-exported clips + reports</text>
  
  <!-- Monitoring -->
  <rect x="1320" y="1100" width="400" height="220" fill="#fff" stroke="#0288D1" stroke-width="2" rx="5"/>
  <text x="1520" y="1125" font-size="14" font-weight="bold" text-anchor="middle">üìä Monitoring & Logging</text>
  
  <rect x="1340" y="1140" width="360" height="165" fill="#f8f9fa" stroke="#0288D1" stroke-width="1" rx="3"/>
  
  <text x="1350" y="1158" font-size="9" font-weight="bold">Metrics Collected:</text>
  
  <text x="1355" y="1175" font-size="8">CloudWatch Metrics:</text>
  <text x="1360" y="1187" font-size="7">‚Ä¢ API request count & latency</text>
  <text x="1360" y="1198" font-size="7">‚Ä¢ Celery task queue depth</text>
  <text x="1360" y="1209" font-size="7">‚Ä¢ Database connection pool</text>
  <text x="1360" y="1220" font-size="7">‚Ä¢ Search response time</text>
  
  <text x="1355" y="1237" font-size="8">Structured Logs (JSON):</text>
  <text x="1360" y="1249" font-size="7">timestamp, level, service, message,</text>
  <text x="1360" y="1260" font-size="7">user_id, request_id, duration_ms</text>
  
  <text x="1355" y="1277" font-size="8">Error Tracking (Sentry):</text>
  <text x="1360" y="1289" font-size="7">‚Ä¢ Exception stack traces</text>
  <text x="1360" y="1300" font-size="7">‚Ä¢ User context & breadcrumbs</text>
  
  <!-- Security -->
  <rect x="1320" y="1340" width="400" height="220" fill="#FFEBEE" stroke="#F44336" stroke-width="2" rx="5"/>
  <text x="1520" y="1365" font-size="14" font-weight="bold" text-anchor="middle">üîí Security Layer</text>
  
  <rect x="1340" y="1380" width="360" height="165" fill="#fff" stroke="#F44336" stroke-width="1" rx="3"/>
  
  <text x="1350" y="1398" font-size="9" font-weight="bold">Authentication Flow:</text>
  <text x="1355" y="1413" font-size="7">1. User ‚Üí POST /login (email, password)</text>
  <text x="1355" y="1424" font-size="7">2. Verify password_hash (bcrypt)</text>
  <text x="1355" y="1435" font-size="7">3. Generate JWT token (30min TTL)</text>
  <text x="1355" y="1446" font-size="7">4. Store session in Redis</text>
  <text x="1355" y="1457" font-size="7">5. Return {access_token, refresh_token}</text>
  
  <text x="1350" y="1475" font-size="9" font-weight="bold">Authorization (RBAC):</text>
  <text x="1355" y="1490" font-size="7">Roles: viewer, analyst, admin</text>
  <text x="1355" y="1501" font-size="7">Permissions checked per endpoint</text>
  
  <text x="1350" y="1519" font-size="9" font-weight="bold">PII Access Audit:</text>
  <text x="1355" y="1534" font-size="7">Log every face reveal ‚Üí audit_log table</text>
  
  <!-- Arrows from App to Data Layer -->
  <path d="M 290 1000 L 290 1100" stroke="#9C27B0" stroke-width="3" marker-end="url(#arrow-purple)"/>
  <text x="300" y="1050" font-size="10" fill="#9C27B0">SQL Queries</text>
  
  <path d="M 690 1000 L 710 1100" stroke="#9C27B0" stroke-width="3" marker-end="url(#arrow-purple)"/>
  <text x="720" y="1050" font-size="10" fill="#9C27B0">Vector Ops</text>
  
  <path d="M 480 850 L 1000 1100" stroke="#4CAF50" stroke-width="2" marker-end="url(#arrow-green)"/>
  <text x="700" y="960" font-size="10" fill="#4CAF50">Cache R/W</text>
  
  <path d="M 600 950 L 1100 1340" stroke="#4CAF50" stroke-width="2" marker-end="url(#arrow-green)"/>
  <text x="800" y="1130" font-size="10" fill="#4CAF50">File Upload</text>
  
  <!-- COMPLETE DATA FLOW EXAMPLE -->
  <rect x="50" y="1650" width="1700" height="720" fill="#F5F5F5" stroke="#333" stroke-width="3" rx="10"/>
  <text x="900" y="1680" font-size="18" font-weight="bold" text-anchor="middle">6. COMPLETE DATA FLOW EXAMPLES</text>
  
  <!-- Example 1: Video Upload -->
  <rect x="80" y="1700" width="520" height="300" fill="#fff" stroke="#4CAF50" stroke-width="2" rx="5"/>
  <text x="340" y="1725" font-size="14" font-weight="bold" text-anchor="middle" fill="#4CAF50">Example 1: Video Upload & Processing</text>
  
  <text x="90" y="1748" font-size="9" font-weight="bold">Step-by-Step Data Flow:</text>
  
  <text x="95" y="1765" font-size="8">1. User uploads video.mp4 (100MB)</text>
  <text x="100" y="1778" font-size="7">‚Üí POST /api/videos/upload</text>
  <text x="100" y="1790" font-size="7">‚Üí Data: multipart/form-data (binary)</text>
  
  <text x="95" y="1807" font-size="8">2. FastAPI saves to S3</text>
  <text x="100" y="1820" font-size="7">‚Üí S3: /raw-videos/uuid.mp4</text>
  <text x="100" y="1832" font-size="7">‚Üí Returns: S3 key</text>
  
  <text x="95" y="1849" font-size="8">3. Create DB record</text>
  <text x="100" y="1862" font-size="7">‚Üí INSERT INTO videos (id, filename, s3_key)</text>
  <text x="100" y="1874" font-size="7">‚Üí Status: 'uploaded'</text>
  
  <text x="95" y="1891" font-size="8">4. Queue Celery task</text>
  <text x="100" y="1904" font-size="7">‚Üí Redis: LPUSH process_video_queue</text>
  <text x="100" y="1916" font-size="7">‚Üí Payload: {video_id: uuid}</text>
  
  <text x="95" y="1933" font-size="8">5. Celery worker processes</text>
  <text x="100" y="1946" font-size="7">‚Üí Download from S3</text>
  <text x="100" y="1958" font-size="7">‚Üí FFmpeg probe: {duration: 120s, fps: 30}</text>
  <text x="100" y="1970" font-size="7">‚Üí FFmpeg segment: 8 √ó 15s chunks</text>
  <text x="100" y="1982" font-size="7">‚Üí UPDATE videos SET duration=120, status='processing'</text>
  
  <!-- Example 2: Search Query -->
  <rect x="630" y="1700" width="540" height="300" fill="#fff" stroke="#2196F3" stroke-width="2" rx="5"/>
  <text x="900" y="1725" font-size="14" font-weight="bold" text-anchor="middle" fill="#2196F3">Example 2: Search Query Execution</text>
  
  <text x="640" y="1748" font-size="9" font-weight="bold">Step-by-Step Data Flow:</text>
  
  <text x="645" y="1765" font-size="8">1. User searches "person in red jacket"</text>
  <text x="650" y="1778" font-size="7">‚Üí POST /api/search</text>
  <text x="650" y="1790" font-size="7">‚Üí JSON: {query: "person in red jacket", limit: 10}</text>
  
  <text x="645" y="1807" font-size="8">2. Check Redis cache</text>
  <text x="650" y="1820" font-size="7">‚Üí Key: search:hash("person in red jacket")</text>
  <text x="650" y="1832" font-size="7">‚Üí Cache MISS (first time query)</text>
  
  <text x="645" y="1849" font-size="8">3. Generate query embedding</text>
  <text x="650" y="1862" font-size="7">‚Üí AWS Nova API: embed_text("person in red jacket")</text>
  <text x="650" y="1874" font-size="7">‚Üí Returns: [float √ó 1024]</text>
  <text x="650" y="1886" font-size="7">‚Üí Cost: $0.0001</text>
  
  <text x="645" y="1903" font-size="8">4. Query Qdrant</text>
  <text x="650" y="1916" font-size="7">‚Üí vector_search(query_vector, top_k=10)</text>
  <text x="650" y="1928" font-size="7">‚Üí Returns: [{id, score: 0.87, payload}, ...]</text>
  <text x="650" y="1940" font-size="7">‚Üí Time: 45ms</text>
  
  <text x="645" y="1957" font-size="8">5. Enrich with PostgreSQL</text>
  <text x="650" y="1970" font-size="7">‚Üí SELECT * FROM segments WHERE id IN (...)</text>
  <text x="650" y="1982" font-size="7">‚Üí JOIN videos ON segments.video_id = videos.id</text>
  
  <!-- Example 3: Real-time Stream -->
  <rect x="1200" y="1700" width="520" height="300" fill="#fff" stroke="#F44336" stroke-width="2" rx="5"/>
  <text x="1460" y="1725" font-size="14" font-weight="bold" text-anchor="middle" fill="#F44336">Example 3: Real-time Stream Search</text>
  
  <text x="1210" y="1748" font-size="9" font-weight="bold">Step-by-Step Data Flow:</text>
  
  <text x="1215" y="1765" font-size="8">1. User opens live stream</text>
  <text x="1220" y="1778" font-size="7">‚Üí WebSocket: /ws/live-search/{query_id}</text>
  <text x="1220" y="1790" font-size="7">‚Üí Connection established (bidirectional)</text>
  
  <text x="1215" y="1807" font-size="8">2. Stream processor starts</text>
  <text x="1220" y="1820" font-size="7">‚Üí RTSP stream ‚Üí OpenCV capture</text>
  <text x="1220" y="1832" font-size="7">‚Üí Buffer: 5 seconds of frames</text>
  
  <text x="1215" y="1849" font-size="8">3. Every 5 seconds:</text>
  <text x="1220" y="1862" font-size="7">‚Üí Save buffer as temp video chunk</text>
  <text x="1220" y="1874" font-size="7">‚Üí Nova: generate embedding</text>
  <text x="1220" y="1886" font-size="7">‚Üí Qdrant: search active queries</text>
  
  <text x="1215" y="1903" font-size="8">4. On match found:</text>
  <text x="1220" y="1916" font-size="7">‚Üí WebSocket: send match data</text>
  <text x="1220" y="1928" font-size="7">‚Üí JSON: {timestamp, score, thumbnail_url}</text>
  <text x="1220" y="1940" font-size="7">‚Üí Client: play alert sound, show notification</text>
  
  <text x="1215" y="1957" font-size="8">5. Store match</text>
  <text x="1220" y="1970" font-size="7">‚Üí INSERT INTO video_segments (...)</text>
  <text x="1220" y="1982" font-size="7">‚Üí S3: save clip for later review</text>
  
  <!-- Performance Metrics -->
  <rect x="80" y="2030" width="800" height="310" fill="#E8F5E9" stroke="#4CAF50" stroke-width="2" rx="5"/>
  <text x="480" y="2055" font-size="14" font-weight="bold" text-anchor="middle">‚ö° Performance & Scalability Metrics</text>
  
  <text x="90" y="2078" font-size="10" font-weight="bold">Data Volumes:</text>
  <text x="95" y="2093" font-size="8">‚Ä¢ Video uploads: 50 GB/day</text>
  <text x="95" y="2105" font-size="8">‚Ä¢ Segments generated: 5,000/day</text>
  <text x="95" y="2117" font-size="8">‚Ä¢ Embeddings stored: 1M vectors</text>
  <text x="95" y="2129" font-size="8">‚Ä¢ Database size: 500 GB</text>
  
  <text x="90" y="2149" font-size="10" font-weight="bold">Response Times (p95):</text>
  <text x="95" y="2164" font-size="8">‚Ä¢ Search query: 120ms total</text>
  <text x="100" y="2176" font-size="7">  - Nova embedding: 50ms</text>
  <text x="100" y="2187" font-size="7">  - Qdrant search: 45ms</text>
  <text x="100" y="2198" font-size="7">  - PostgreSQL join: 25ms</text>
  <text x="95" y="2212" font-size="8">‚Ä¢ Video upload: 2-5 seconds</text>
  <text x="95" y="2224" font-size="8">‚Ä¢ Processing: 1.5√ó real-time</text>
  
  <text x="90" y="2244" font-size="10" font-weight="bold">Throughput:</text>
  <text x="95" y="2259" font-size="8">‚Ä¢ Concurrent searches: 100/sec</text>
  <text x="95" y="2271" font-size="8">‚Ä¢ Video processing: 10 concurrent</text>
  <text x="95" y="2283" font-size="8">‚Ä¢ Live streams: 50 simultaneous</text>
  
  <text x="90" y="2303" font-size="10" font-weight="bold">Caching Impact:</text>
  <text x="95" y="2318" font-size="8">‚Ä¢ Cache hit rate: 75%</text>
  <text x="95" y="2330" font-size="8">‚Ä¢ Cached queries: 15ms (8√ó faster)</text>
  
  <!-- Cost Breakdown -->
  <rect x="920" y="2030" width="800" height="310" fill="#FFF3E0" stroke="#FF9800" stroke-width="2" rx="5"/>
  <text x="1320" y="2055" font-size="14" font-weight="bold" text-anchor="middle">üí∞ Data Storage & Transfer Costs</text>
  
  <text x="930" y="2078" font-size="10" font-weight="bold">Monthly Data Costs:</text>
  
  <text x="935" y="2095" font-size="9" font-weight="bold">AWS S3:</text>
  <text x="940" y="2108" font-size="8">‚Ä¢ Raw videos: 1.5 TB √ó $0.023/GB = $34.50</text>
  <text x="940" y="2120" font-size="8">‚Ä¢ Processed segments: 500 GB √ó $0.023 = $11.50</text>
  <text x="940" y="2132" font-size="8">‚Ä¢ Data transfer: 200 GB √ó $0.09 = $18.00</text>
  <text x="940" y="2144" font-size="8">Subtotal: $64/month</text>
  
  <text x="935" y="2162" font-size="9" font-weight="bold">AWS RDS (PostgreSQL):</text>
  <text x="940" y="2175" font-size="8">‚Ä¢ db.t3.medium: $40/month</text>
  <text x="940" y="2187" font-size="8">‚Ä¢ Storage: 500 GB √ó $0.115 = $57.50</text>
  <text x="940" y="2199" font-size="8">Subtotal: $97.50/month</text>
  
  <text x="935" y="2217" font-size="9" font-weight="bold">AWS Nova API:</text>
  <text x="940" y="2230" font-size="8">‚Ä¢ Embeddings: 150K segments √ó $0.001 = $150</text>
  <text x="940" y="2242" font-size="8">‚Ä¢ LLM (reports): 5M tokens √ó $0.30/M = $1.50</text>
  <text x="940" y="2254" font-size="8">Subtotal: $151.50/month</text>
  
  <text x="935" y="2272" font-size="9" font-weight="bold">Redis ElastiCache:</text>
  <text x="940" y="2285" font-size="8">‚Ä¢ cache.t3.micro: $15/month</text>
  
  <text x="935" y="2303" font-size="9" font-weight="bold">Qdrant (EC2):</text>
  <text x="940" y="2316" font-size="8">‚Ä¢ t3.large: $65/month</text>
  
  <text x="930" y="2335" font-size="11" font-weight="bold" fill="#E65100">TOTAL: ~$393/month (production scale)</text>
  
  <!-- Arrow markers -->
  <defs>
    <marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#2196F3"/>
    </marker>
    <marker id="arrow-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#4CAF50"/>
    </marker>
    <marker id="arrow-orange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#FF9800"/>
    </marker>
    <marker id="arrow-purple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#9C27B0"/>
    </marker>
    <marker id="arrow-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#F44336"/>
    </marker>
  </defs>
</svg>
